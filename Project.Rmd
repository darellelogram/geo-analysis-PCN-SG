---
title: "BT4015 Project"
author: "Group 1"
date: "2022-10-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setting up

```{r pressure, echo=FALSE, warning=FALSE, error=FALSE}
library(GISTools)
library(tmap)
library(sp)
library(sf)
library(raster)
library(rgdal)
library(spatstat)
```

## Loading data
### Polygons and lines
```{r, warning=FALSE, error=FALSE}
planning_area_sf <- st_read("data/town-councils/Planning_Area_Census2010.kml")
sg <- readOGR("./data/town-councils", "Region_Census2010")
sg_combined <- gUnaryUnion(sg)
sgclass(planning_area_sf)
```
### Points
Next we read in point data. The first set of point data is the Park Connector (PCN) access points themselves.
Next, we have data on various public amenities like supermarkets, hawker centres, pharmacies as well as transportation infrastructure like MRT exits.
```{r}
access_points_sf <- st_read("data/PCNs/PCN_Access_Points.kml")
supermarkets_sf <- st_read("data/amenities/supermarkets/supermarkets.kml")
hawkercentres_sf <- st_read("data/amenities/hawker-centres/hawkercentre.kml")
mrt_exits_sf <- st_read("data/MRTs/lta-mrt-station-exit-kml.kml")
pharmacy_sf <- st_read("data/amenities/pharmacies/retail-pharmacy-locations-kml.kml")

class(access_points_sf)
class(supermarkets_sf)
class(hawkercentres_sf)
class(mrt_exits_sf)
class(pharmacy_sf)
```
### Raster
Next, we read in raster data, which consists of only population density data.
```{r}
GDALinfo("data/population-density/popmap15adj.tif")
```

```{r}
pop_density <- raster("data/population-density/popmap15adj.tif")
pop_density
```
## Exploratory Data Analysis
### Park Connectors
First, we plot the PCN access points. On first glance, it is apparent that these points cannot be randomly distributed, with noticeable clusters in the Choa Chu Kang/Bukit Batok area as well as the Woodlands/Sembawang area. The points also seem to occur as a "string" of points, which obviously stands to reason since these are access points to Park Connectors which are essentially lines.
```{r}
tmap_mode("plot")
tm_shape(sg_combined) + tm_borders() + tmap_options(check.and.fix = TRUE) + tm_shape(access_points_sf) + tm_symbols(size = 0.1, alpha = 0.5, col = "red")+ tm_layout(title="PCN Access Points in Singapore", title.size = 0.65, title.position = c(0.02, "bottom"))
```
## Plot various amenities over the PCN access points
Now, we will display the geographical distribution of the various amenities (supermarkets, hawker centres, etc.) on top of the locations of the PCN access points.
### Supermarkets
We plot the locations of supermarkets overlaid with the access points on a map of Singapore. We see that most access points are located very close to supermarkets.
```{r}
tmap_mode("plot")

tm_shape(sg_combined) + tm_borders() + tmap_options(check.and.fix = TRUE) +
  tm_shape(access_points_sf) + tm_symbols(size = 0.1, alpha = 0.5, col = "red", legend.col.show=TRUE, shapes.labels='PCAPs') + tm_add_legend(type="symbol", labels=c("PCAPs"), col='red') +
  tm_shape(supermarkets_sf) + tm_symbols(size = 0.1, alpha = 0.5, col = "skyblue", legend.col.show=TRUE, shapes.labels='supermarkets') + tm_add_legend(type="symbol", labels=c("supermarkets"), col='skyblue') +
  tm_layout(title="PCN Access Points in Singapore", title.size = 0.65, title.position = c(0.02, "bottom"), legend.show=TRUE, legend.outside=FALSE, legend.text.size=0.7) 

```
### Hawker centres
For hawker centres, the correlation is not as obvious.
```{r}
tmap_mode("plot")

tm_shape(sg_combined)+ tm_borders() + tmap_options(check.and.fix = TRUE) + tm_shape(access_points_sf) + tm_symbols(size = 0.1, alpha = 0.5, col = "red") + tm_add_legend(type="symbol", labels=c("PCAPs"), col='red') +
  tm_shape(hawkercentres_sf) + tm_symbols(size = 0.1, alpha = 0.5, col = "green") + tm_add_legend(type="symbol", labels=c("hawker centres"), col='green') + 
  tm_layout(title="PCAPs and Hawker Centres", title.size = 0.65, title.position = c(0.02, "bottom"))
```
### MRT exits
For MRT exits, we notice that the Downtown Core area has a high concentration of exits. This could be because many of the stations in that area have many exits, sometimes as many as 7 or 8. This makes it seem more numerous. We can try getting a dataset of just MRT stations themselves to help us narrow down our investigation.
Unlike the MRT exits, we see that there are very few PCN access points in the Downtown Core area. This could be because of the lower priority assigned to cycling paths over mass rapid transit in a space-scarce area like the Downtown Core.
```{r}
tmap_mode("plot")

tm_shape(sg_combined) + tm_borders() + tmap_options(check.and.fix = TRUE) + 
  tm_shape(access_points_sf) + tm_symbols(size = 0.1, alpha = 0.5, col = "red") + tm_add_legend(type="symbol", labels=c("PCAPs"), col='red') +
  tm_shape(mrt_exits_sf) + tm_symbols(size = 0.1, alpha = 0.5, col = "navyblue") + tm_add_legend(type="symbol", labels=c("MRT exits"), col='navyblue') +
  tm_layout(title="PCAPs and MRT exits", title.size = 0.65, title.position = c(0.02, "bottom"))
```
### Pharmacies
For pharmacies, there doesn't seem to be a clear pattern.
```{r}
tmap_mode("plot")

tm_shape(sg_combined) + tm_borders() + tmap_options(check.and.fix = TRUE) +
  tm_shape(access_points_sf) + tm_symbols(size = 0.1, alpha = 0.5, col = "red") + tm_add_legend(type="symbol", labels=c("PCAPs"), col='red') + 
  tm_shape(pharmacy_sf) + tm_symbols(size = 0.1, alpha = 0.5, col = "purple") + tm_add_legend(type="symbol", labels=c("pharmacies"), col='purple') +
  tm_layout(title="PCAPs and pharmacies", title.size = 0.65, title.position = c(0.02, "bottom"))
```
### Population density
Interestingly, areas with the highest population density (Serangoon, Hougang and the areas surrounding Paya Lebar) seem to be relatively underserved by acces points as compared to Western regions like Bukit Batok which has a much lower population density.

Standing out as well is the central part of Singapore, which has virtually zero population density. This region encompasses the MacRitchie Reservoir area and naturally is not home to any human population density. It might be useful to exclude this region in later analysis to prevent confounding.
```{r}
tmap_mode("plot")

tm_shape(pop_density, bbox=st_bbox(sg_combined)) + tm_raster(title="Population Density") +
  tm_shape(access_points_sf) + tm_symbols(size = 0.1, alpha = 0.5, col = "green") + tm_add_legend(type="symbol", labels=c("PCAPs"), col='green') +
  tm_shape(sg_combined) + tm_borders() + 
  tm_layout(title="PCAPs and Population Density", title.size = 0.65, title.position = c(0.02, "bottom"), legend.position=c("right", "bottom"))
```

## Extracting planning areas to observe
```{r, echo=FALSE, }
training_sf <- planning_area_sf[planning_area_sf$Name %in% c("YISHUN","JURONG EAST", "JURONG WEST", "TAMPINES", "PASIR RIS", "BEDOK"),]
# training_sf
```
## Calculating global density
```{r}
sg_area <- 728.6 #km2
supermarkets_gd <- 742 / sg_area
hawkercentres_gd <- 125 / sg_area
mrt_exits_gd <- 474 / sg_area
pharmacy_gd <- 269 / sg_area
```
## Quadrat density
```{r}
sg <- readOGR("./data/town-councils", "Region_Census2010")
sg
sg_window <- as.owin(sg)
```

```{r}
# convert crs of access_points_sf to crs of sg
access_points_q <- st_transform(access_points_sf, crs(sg))
# convert sf to ppp
access_points_ppp <- as.ppp(st_coordinates(access_points_q), W=sg_window)
```
Try plotting quadrats of various sizes.
```{r}
Q6 <- quadratcount(access_points_ppp, nx=6, ny=6)
plot(Q6)
```

```{r}
Q10 <- quadratcount(access_points_ppp, nx=10, ny=10)
Q15 <- quadratcount(access_points_ppp, nx=15, ny=15)
Q20 <- quadratcount(access_points_ppp, nx=20, ny=20)
Q40 <- quadratcount(access_points_ppp, nx=40, ny=40)
plot(Q20)
```
From the quadrat density graph, we again see that most access points are concentrated in the North and West.
```{r}
# compute density within each quadrat
Q_density <- intensity(Q40)

# plot the density raster
plot(intensity(Q10, image=TRUE), main=NULL, las=1)
# plot access points
plot(access_points_ppp, pch=20, cex=0.6, col=rgb(0,0,0,.5), add=TRUE)
```

```{r}
# plot the density raster
plot(intensity(Q20, image=TRUE), main=NULL, las=1)
# plot access points
plot(access_points_ppp, pch=20, cex=0.6, col=rgb(0,0,0,.5), add=TRUE)

```

```{r}
# plot the density raster
plot(intensity(Q20, image=TRUE), main=NULL, las=1)
legend(add = TRUE, 'bottomright', inset=0.05, lty=0, title="point density", legend=seq(0, 6, 1))

# plot access points
plot(access_points_ppp, pch=20, cex=0.6, col=rgb(0,0,0,.5), add=TRUE)
```

## Quadrat density based on population density
```{r}
pop_density_q <- projectRaster(pop_density, crs = crs(sg))

brks <- c(0, 50, 100, 150, 200, 250, 300)
zcut <- cut(pop_density_q, breaks = brks)
pop_tess <- tess(image = zcut)

Qpop <- quadratcount(access_points_ppp, tess = pop_tess)
```

```{r}
plot(Qpop, main="", las=1)
```

```{r}
# compute density within each quadrat
Qpop_density <- intensity(Qpop)
Qpop_density
```

```{r}
cl <-  interp.colours(c("blue", "green", "yellow", "orange", "red", "darkred"), 6)
# plot the density raster
plot(intensity(Qpop, image=TRUE), main=NULL, las=1, col=cl)
# plot access points
plot(access_points_ppp, pch=20, cex=0.6, col=rgb(0,0,0,.5), add=TRUE)
```

# Monte Carlo Q20 (Shu Ling)
```{r}
ann_observed <- mean(nndist(access_points_ppp, k=1))
ann_observed
```
## Population density
```{r}
n <- 1000 # number of simulations
ann_pop <- vector(length = n) # empty object to be used to store simulated ANN values
pop_density_im <- as.im(pop_density_q) # convert population density to im object

for (i in 1:n) {
  random_point <- rpoint(n=access_points_ppp$n, f=pop_density_im)
  ann_pop[i] <- mean(nndist(random_point, k=1))
}

Window(random_point) <- sg_window
plot(random_point, pch=16, main=NULL, cols=rgb(0,0,0,0.5))
```
```{r}
hist(ann_pop, main=NULL, las=1, breaks=40, col="bisque", xlim=range(ann_observed, ann_pop))
abline(v=ann_observed, col="blue")
```
## MRT exits
```{r}
# convert crs of access_points_sf to crs of sg
mrt_exits_q <- st_transform(mrt_exits_sf, crs(sg))
# convert sf to ppp
mrt_exits_ppp <- as.ppp(st_coordinates(mrt_exits_q), W=sg_window)

MRT_Qpop0 <- quadratcount(mrt_exits_ppp, nx=20, ny=20)
plot(MRT_Qpop0)
```
```{r}
MRT_density20 <- intensity(MRT_Qpop0, image=TRUE)
plot(MRT_density20)
class(MRT_density20)
```

```{r}
n <- 1000 # number of simulations
ann_mrt <- vector(length = n) # empty object to be used to store simulated ANN values

for (i in 1:n) {
  random_point <- rpoint(n=access_points_ppp$n, f=MRT_density20)
  ann_mrt[i] <- mean(nndist(random_point, k=1))
}

Window(random_point) <- sg_window
plot(random_point, pch=16, main=NULL, cols=rgb(0,0,0,0.5))
```

```{r}
hist(ann_mrt, main=NULL, las=1, breaks=40, col="bisque", xlim=range(ann_observed, ann_mrt))
abline(v=ann_observed, col="blue")
```
# Interpolating using distance
## MRT Exits
First, we want to find the extent of sg
```{r}
sg
```
Create a raster using the extent of Singapore
```{r}
r <- raster(ncol=1000, nrow=1000, xmn= 2637.869, xmx=56396.44, ymn=15748.72, ymx=50256.33)
```
Convert MRT exits with the same CRS as sg to an sp object
```{r}
mrt_exits_q_sp <- as(mrt_exits_q, "Spatial")
class(mrt_exits_q_sp)
```
Get x and y coordinates from MRT exits
```{r}
distances_mrt <- distanceFromPoints(object = r, xy=coordinates(mrt_exits_q_sp)[,1:2])
plot(distances_mrt)
```
Mask the distances_mrt raster with the shape of Singapore
```{r}
distances_mrt <- mask(distances_mrt, sg)
plot(distances_mrt)
plot(access_points_ppp, add = TRUE)
```
Convert distances_mrt from raster to im
```{r}
class(distances_mrt)
distances_mrt_im <- as.im(distances_mrt)
class(distances_mrt_im)
```
Run monte carlo simulation for 1000 epochs
```{r}
n <- 1000 # number of simulations
ann_distances_mrt <- vector(length = n) # empty object to be used to store simulated ANN values

for (i in 1:n) {
  random_point <- rpoint(n=access_points_ppp$n, f=distances_mrt_im)
  ann_distances_mrt[i] <- mean(nndist(random_point, k=1))
}

Window(random_point) <- sg_window
plot(distances_mrt)
plot(random_point, pch=16, main=NULL, cols=rgb(0,0,0,0.5), add=TRUE)
```

```{r}
hist(ann_distances_mrt, main=NULL, las=1, breaks=40, col="bisque", xlim=range(ann_observed, ann_distances_mrt))
abline(v=ann_observed, col="blue")
```

```{r}
n <- 1000 # number of simulations
ann_distances_mrt <- vector(length = n) # empty object to be used to store simulated ANN values

for (i in 1:n) {
  random_point <- rpoint(n=access_points_ppp$n, f=distances_mrt_im)
  ann_distances_mrt[i] <- mean(nndist(random_point, k=2))
}

Window(random_point) <- sg_window
plot(distances_mrt)
plot(random_point, pch=16, main=NULL, cols=rgb(0,0,0,0.5), add=TRUE)
```
```{r}
hist(ann_distances_mrt, main=NULL, las=1, breaks=40, col="bisque", xlim=range(ann_observed, ann_distances_mrt))
abline(v=ann_observed, col="blue")
```

## Parks
```{r}
parks <- st_read("data/parks-geojson.geojson")
class(parks)
```
```{r}
parks2 <- st_transform(parks, crs(sg))
```
```{r}
parks_sp <- as(parks2, "Spatial")
class(parks_sp)
```
Get x and y coordinates from MRT exits
```{r}
distances_parks <- distanceFromPoints(object = r, xy=coordinates(parks_sp)[,1:2])
plot(distances_parks)
```
Mask the distances_mrt raster with the shape of Singapore
```{r}
distances_parks <- mask(distances_parks, sg)
plot(distances_parks)
plot(access_points_ppp, add = TRUE)
```
Convert distances_mrt from raster to im
```{r}
class(distances_parks)
distances_parks_im <- as.im(distances_parks)
class(distances_parks)
```
Run monte carlo simulation for 1000 epochs
```{r}
n <- 1000 # number of simulations
ann_distances_parks <- vector(length = n) # empty object to be used to store simulated ANN values

for (i in 1:n) {
  random_point <- rpoint(n=access_points_ppp$n, f=distances_parks_im)
  ann_distances_parks[i] <- mean(nndist(random_point, k=1))
}

Window(random_point) <- sg_window
plot(distances_parks)
plot(random_point, pch=16, main=NULL, cols=rgb(0,0,0,0.5), add=TRUE)
```
```{r}
hist(ann_distances_parks, main=NULL, las=1, breaks=40, col="bisque", xlim=range(ann_observed, ann_distances_parks))
abline(v=ann_observed, col="blue")
```






## Markov Chain
```{r}
library(rgdal)
library(maptools)
library(raster)
n <- 500
ann.r <- vector(length=n)

for (i in 1:n) {
  rand.p <- rpoint(n=length(access_points_q), f=Q20)
  ann.r[i] <- mean(nndist(rand.p, k=1))
}

## try with nsim argument
rpoint(n=length(access_points_q), f=Qpop0_tess_im, nsim=1)

Window(rand.p) <- ma.km
plot(rand.p, pch=16, main=NULL, cols=rgb(0,0,0,0.5))
```


# Global Raster function for distance heatmap
## Try with MRT station data (Polygons) instead of MRT station exits data (Points) -> less duplication
## Import MRT station data
```{r}
# NOTE: each MRT is represented by a polygon
# mrt_sf <- st_read('data/master-plan-2019-rail-station-layer-kml.kml')
mrt_sf <- st_read('data/master-plan-2019-rail-station-layer-kml.geojson')
# remove NAs
mrt_sf <- mrt_sf[!is.na(mrt_sf$NAME),]
# remove useless columns
mrt_sf <- mrt_sf[,!names(mrt_sf) %in% c('id', 'name', 'description', 'INC_CRC', 'FMEL_UPD_D')]
plot(mrt_sf['geometry'])
```


## Convert MRT stations to raster data
```{r}
library(tidyverse)
library(sf)
library(raster)
# need to define the extent of Singapore's boundaries first?
# what resolution to use?

#https://gis.stackexchange.com/questions/407991/convert-sf-data-frame-to-raster-in-r
library(stars)

mrt_raster <- st_rasterize(mrt_sf %>% dplyr::select(geometry))
plot(mrt_raster, axes=TRUE)

# change continuous values to either 1s or NAs
print(mrt_raster[["ID"]][!is.na(mrt_raster[["ID"]])])
mrt_raster_1s <- raster(mrt_raster[["ID"]])
mrt_raster_1s[!is.na(mrt_raster_1s)] = 1
print(mrt_raster_1s[!is.na(mrt_raster_1s)])
plot(mrt_raster_1s, col='black')
```


## Call global raster function to generate distance heat map
```{r}
mrt.1s.d <- distance(mrt_raster_1s)

# plot distance heat map over MRT stations
tm_shape(mrt.1s.d) + tm_raster(palette="Greens", style="order", title="Distance") +
  tm_legend(outside=TRUE, text.size=.8) +
  tm_shape(mrt_raster_1s) + tm_raster(palette="red", title="Points")
```






